{% extends "base.html" %}

{% block title %}Consistency Plots - W3A Test Analysis{% endblock %}

{% block content %}
<div class="four-panel-layout">
    <div class="panel left-panel">
        <div class="panel-header">
            <h3>Test Plan CSV</h3>
        </div>
        <div class="panel-content">
            <div class="file-upload-section">
                <div class="form-group">
                    <label for="csv_file_path">File Path</label>
                    <input type="text" 
                           class="form-control" 
                           id="csv_file_path" 
                           placeholder="/path/to/test_plan.csv">
                </div>
                
                <div class="form-group">
                    <label for="csv_file_upload">Or Browse File</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="csv_file_upload" 
                           accept=".csv"
                           style="margin-bottom: 0.5rem;">
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-sm btn-primary" onclick="uploadFile('csv')">
                        Upload
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearFile('csv')">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="file-display" id="csv_display" style="display: none;">
                <h4>File Content:</h4>
                <div class="file-content" id="csv_content"></div>
            </div>
        </div>
    </div>

    <div class="panel second-panel">
        <div class="panel-header">
            <h3>Test Plan YAML</h3>
        </div>
        <div class="panel-content">
            <div class="file-upload-section">
                <div class="form-group">
                    <label for="yaml_file_path">File Path</label>
                    <input type="text" 
                           class="form-control" 
                           id="yaml_file_path" 
                           placeholder="/path/to/test_plan.yaml">
                </div>
                
                <div class="form-group">
                    <label for="yaml_file_upload">Or Browse File</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="yaml_file_upload" 
                           accept=".yaml,.yml"
                           style="margin-bottom: 0.5rem;">
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-sm btn-primary" onclick="uploadFile('yaml')">
                        Upload
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearFile('yaml')">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="file-display" id="yaml_display" style="display: none;">
                <h4>File Content:</h4>
                <div class="file-content" id="yaml_content"></div>
            </div>
        </div>
    </div>

    <div class="panel third-panel">
        <div class="panel-header">
            <h3>Step Config YAML</h3>
        </div>
        <div class="panel-content">
            <div class="file-upload-section">
                <div class="form-group">
                    <label for="step_file_path">File Path</label>
                    <input type="text" 
                           class="form-control" 
                           id="step_file_path" 
                           placeholder="/path/to/step_config.yaml">
                </div>
                
                <div class="form-group">
                    <label for="step_file_upload">Or Browse File</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="step_file_upload" 
                           accept=".yaml,.yml"
                           style="margin-bottom: 0.5rem;">
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-sm btn-primary" onclick="uploadFile('step')">
                        Upload
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearFile('step')">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="file-display" id="step_display" style="display: none;">
                <h4>File Content:</h4>
                <div class="file-content" id="step_content"></div>
            </div>
        </div>
    </div>

    <div class="panel right-panel">
        <div class="panel-header">
            <h3>Generate Consistency Plots</h3>
            <p>Upload your W3A test logs to generate statistical process control charts with ¬±3œÉ limits.</p>
        </div>
        <div class="panel-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div id="alert-container">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'error' if category == 'error' else category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="file-upload-section">
                <div class="form-group">
                    <label for="log_file_upload">Upload Log Files</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="log_file_upload" 
                           multiple 
                           accept=".zip,.csv">
                    <small class="form-text text-muted">
                        Select ZIP files or CSV files containing your W3A test logs.
                    </small>
                </div>

                <div class="form-group">
                    <label for="log_directory_path">Or Enter Log Path</label>
                    <input type="text" 
                           class="form-control" 
                           id="log_directory_path" 
                           placeholder="/path/to/logs/directory OR /path/to/single_file.zip">
                    <small class="form-text text-muted">
                        Enter the full path to a directory containing W3A logs, or path to a single ZIP file.
                    </small>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="uploadLogs()">
                        üìÅ Load Logs
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="clearLogs()">
                        üóëÔ∏è Clear
                    </button>
                </div>
            </div>

            <div class="report-selection-section">
                <h4>Report Types</h4>
                <div class="checkbox-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="consistency-report" onchange="updateGenerateButton()">
                        <label class="form-check-label" for="consistency-report">
                            Generate Consistency Report
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="limits-report" onchange="updateGenerateButton()">
                        <label class="form-check-label" for="limits-report">
                            Generate Limits Report
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="failure-pareto" onchange="updateGenerateButton()">
                        <label class="form-check-label" for="failure-pareto">
                            Generate Failure Pareto
                        </label>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary btn-lg w-100 mt-3" id="generate-plots-btn" onclick="generatePlots()">
                    <span id="btn-text">Please select at least one report type</span>
                    <span id="loading-spinner" style="display: none;">
                        Processing... ‚è≥
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.four-panel-layout {
    display: flex;
    height: calc(100vh - 140px);
    gap: 1rem;
    padding: 1rem;
}

.panel {
    flex: 1;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow-y: auto;
}

.panel-header {
    background-color: #f8f9fa;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
}

.panel-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.25rem;
}

.panel-header p {
    margin: 0.5rem 0 0 0;
    color: #666;
    font-size: 0.9rem;
}

.panel-content {
    padding: 1.5rem;
}

.left-panel, .second-panel, .third-panel {
    max-width: 250px;
}

.right-panel {
    flex: 2;
    min-width: 400px;
}
.example-paths {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    border-left: 4px solid #3498db;
}

.example-paths code {
    display: block;
    margin: 0.5rem 0;
    padding: 0.25rem 0.5rem;
    background-color: #e9ecef;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

.info-section h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
}

.info-section h4 {
    color: #3498db;
    margin-bottom: 0.5rem;
}

.form-text {
    color: #6c757d;
    font-size: 0.875rem;
}

.config-section {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 6px;
    margin: 1.5rem 0;
    border-left: 4px solid #17a2b8;
}

.config-section h4 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.config-section p {
    margin-bottom: 1rem;
}

/* File Upload Styling */
.file-upload-section {
    margin-bottom: 1.5rem;
}

.file-upload-section .form-group {
    margin-bottom: 1rem;
}

.file-upload-section label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    display: block;
}

.form-control-file {
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.button-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}

.file-display {
    margin-top: 1.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.file-display h4 {
    color: #2c3e50;
    margin-bottom: 0.75rem;
    font-size: 1rem;
}

.file-content {
    background-color: #fff;
    padding: 1rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Report Selection Styling */
.report-selection-section {
    margin-top: 2rem;
    padding: 1.5rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.report-selection-section h4 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.checkbox-group {
    margin-bottom: 1rem;
}

.form-check {
    margin-bottom: 0.75rem;
    padding-left: 1.5rem;
}

.form-check-input {
    margin-left: -1.5rem;
    margin-top: 0.25rem;
}

.form-check-label {
    color: #495057;
    font-weight: 500;
    cursor: pointer;
    user-select: none;
}

.form-check-input:checked + .form-check-label {
    color: #007bff;
}

#generate-plots-btn.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('consistency-form').addEventListener('submit', function(e) {
    const btn = document.getElementById('generate-btn');
    const btnText = document.getElementById('btn-text');
    const spinner = document.getElementById('loading-spinner');
    
    // Show loading state
    btn.disabled = true;
    btnText.style.display = 'none';
    spinner.style.display = 'inline';
    
    // Validate form
    const logDir = document.getElementById('log_directory').value.trim();
    if (!logDir) {
        e.preventDefault();
        alert('Please enter a log directory path.');
        
        // Reset button
        btn.disabled = false;
        btnText.style.display = 'inline';
        spinner.style.display = 'none';
        return;
    }
});

// Auto-remove alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(function() {
                alert.remove();
            }, 500);
        });
    }, 5000);
});

// File upload functions
function uploadFile(fileType) {
    let fileInput, pathInput;
    
    if (fileType === 'csv') {
        fileInput = document.getElementById('csv_file_upload');
        pathInput = document.getElementById('csv_file_path');
    } else if (fileType === 'yaml') {
        fileInput = document.getElementById('yaml_file_upload');
        pathInput = document.getElementById('yaml_file_path');
    } else if (fileType === 'step') {
        fileInput = document.getElementById('step_file_upload');
        pathInput = document.getElementById('step_file_path');
    }
    
    const file = fileInput.files[0];
    const filePath = pathInput.value.trim();
    
    if (!file && !filePath) {
        alert('Please select a file or enter a file path.');
        return;
    }
    
    if (file) {
        // Handle file upload via FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_type', fileType);
        
        fetch('/upload_file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFileContent(fileType, data.content, data.filename);
            } else {
                alert('Upload error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed: ' + error.message);
        });
        
    } else if (filePath) {
        // Handle file path via JSON
        fetch('/read_file_path', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_path: filePath,
                file_type: fileType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFileContent(fileType, data.content, data.filename);
            } else {
                alert('File read error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('File read failed: ' + error.message);
        });
    }
}

function clearFile(fileType) {
    // Clear inputs
    if (fileType === 'csv') {
        document.getElementById('csv_file_upload').value = '';
        document.getElementById('csv_file_path').value = '';
        document.getElementById('csv_display').style.display = 'none';
    } else if (fileType === 'yaml') {
        document.getElementById('yaml_file_upload').value = '';
        document.getElementById('yaml_file_path').value = '';
        document.getElementById('yaml_display').style.display = 'none';
    } else if (fileType === 'step') {
        document.getElementById('step_file_upload').value = '';
        document.getElementById('step_file_path').value = '';
        document.getElementById('step_display').style.display = 'none';
    }
}

function displayFileContent(fileType, content, fileName) {
    let displayDiv, contentDiv;
    
    if (fileType === 'csv') {
        displayDiv = document.getElementById('csv_display');
        contentDiv = document.getElementById('csv_content');
    } else if (fileType === 'yaml') {
        displayDiv = document.getElementById('yaml_display');
        contentDiv = document.getElementById('yaml_content');
    } else if (fileType === 'step') {
        displayDiv = document.getElementById('step_display');
        contentDiv = document.getElementById('step_content');
    }
    
    // Limit content display to first 2000 characters for performance
    let displayContent = content;
    if (content.length > 2000) {
        displayContent = content.substring(0, 2000) + '\n\n... (content truncated, showing first 2000 characters)';
    }
    
    contentDiv.textContent = `File: ${fileName}\n\n${displayContent}`;
    displayDiv.style.display = 'block';
}

// New log upload functions
function uploadLogs() {
    const fileInput = document.getElementById('log_file_upload');
    const pathInput = document.getElementById('log_directory_path');
    
    const files = fileInput.files;
    const dirPath = pathInput.value.trim();
    
    if (files.length === 0 && !dirPath) {
        alert('Please select log files or enter a directory path.');
        return;
    }
    
    if (files.length > 0) {
        // Handle file uploads
        alert(`Selected ${files.length} files for processing. Files will be processed when you click "Generate Consistency Plots".`);
    } else if (dirPath) {
        // Handle directory path
        alert(`Directory path set: ${dirPath}\nClick "Generate Consistency Plots" to process logs from this directory.`);
    }
}

function clearLogs() {
    document.getElementById('log_file_upload').value = '';
    document.getElementById('log_directory_path').value = '';
    alert('Log inputs cleared.');
}

// Update generate button based on checkbox selection
function updateGenerateButton() {
    const consistencyCheck = document.getElementById('consistency-report').checked;
    const limitsCheck = document.getElementById('limits-report').checked;
    const paretoCheck = document.getElementById('failure-pareto').checked;
    
    const btn = document.getElementById('generate-plots-btn');
    const btnText = document.getElementById('btn-text');
    
    const selectedCount = [consistencyCheck, limitsCheck, paretoCheck].filter(Boolean).length;
    
    if (selectedCount === 0) {
        btnText.textContent = 'Please select at least one report type';
        btn.classList.add('disabled');
        btn.disabled = true;
    } else {
        let reportTypes = [];
        if (consistencyCheck) reportTypes.push('Consistency');
        if (limitsCheck) reportTypes.push('Limits');
        if (paretoCheck) reportTypes.push('Pareto');
        
        btnText.textContent = `Generate ${reportTypes.join(' + ')} Report${selectedCount > 1 ? 's' : ''}`;
        btn.classList.remove('disabled');
        btn.disabled = false;
    }
}

function generatePlots() {
    // Check if button is disabled
    const btn = document.getElementById('generate-plots-btn');
    if (btn.disabled) {
        alert('Please select at least one report type first.');
        return;
    }
    
    const fileInput = document.getElementById('log_file_upload');
    const pathInput = document.getElementById('log_directory_path');
    const btnText = document.getElementById('btn-text');
    const spinner = document.getElementById('loading-spinner');
    
    const files = fileInput.files;
    const dirPath = pathInput.value.trim();
    
    if (files.length === 0 && !dirPath) {
        alert('Please upload log files or enter a directory path first.');
        return;
    }
    
    // Get selected report types
    const consistencyCheck = document.getElementById('consistency-report').checked;
    const limitsCheck = document.getElementById('limits-report').checked;
    const paretoCheck = document.getElementById('failure-pareto').checked;
    
    // Show loading state
    btn.disabled = true;
    btnText.style.display = 'none';
    spinner.style.display = 'inline';
    
    // Process each selected report type
    const promises = [];
    
    if (consistencyCheck) {
        promises.push(generateConsistencyReport(dirPath));
    }
    
    if (limitsCheck) {
        promises.push(generateLimitsReport(dirPath));
    }
    
    if (paretoCheck) {
        promises.push(generateParetoReport(dirPath));
    }
    
    // Execute all selected reports
    Promise.all(promises)
        .then(results => {
            displayCombinedResults(results);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Report generation failed: ' + error.message);
        })
        .finally(() => {
            // Reset button
            btn.disabled = false;
            btnText.style.display = 'inline';
            spinner.style.display = 'none';
            updateGenerateButton(); // Restore proper button state
        });
}

// Individual report generation functions
function generateConsistencyReport(dirPath) {
    return new Promise((resolve, reject) => {
        // Placeholder for consistency report generation
        setTimeout(() => {
            resolve({
                type: 'consistency',
                message: 'Consistency report functionality will be implemented next!',
                success: true
            });
        }, 1000);
    });
}

function generateLimitsReport(dirPath) {
    return new Promise((resolve, reject) => {
        // Placeholder for limits report generation
        setTimeout(() => {
            resolve({
                type: 'limits',
                message: 'Limits report functionality will be implemented next!',
                success: true
            });
        }, 1000);
    });
}

function generateParetoReport(dirPath) {
    return fetch('/analyze_failures', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            log_directory: dirPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return {
                type: 'pareto',
                data: data,
                success: true
            };
        } else {
            throw new Error('Pareto analysis error: ' + data.error);
        }
    });
}

function displayCombinedResults(results) {
    // Clear any existing results
    const rightPanel = document.querySelector('.right-panel .panel-content');
    const existingResults = rightPanel.querySelector('.combined-results');
    
    if (existingResults) {
        existingResults.remove();
    }
    
    let combinedHtml = '<div class="combined-results" style="margin-top: 2rem;">';
    
    results.forEach(result => {
        if (result.type === 'consistency') {
            combinedHtml += `
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff;">
                    <h3 style="color: #007bff; margin-bottom: 1rem;">üìä Consistency Report</h3>
                    <p>${result.message}</p>
                </div>
            `;
        } else if (result.type === 'limits') {
            combinedHtml += `
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 1rem;">üìè Limits Report</h3>
                    <p>${result.message}</p>
                </div>
            `;
        } else if (result.type === 'pareto') {
            combinedHtml += generateParetoResultsHtml(result.data);
        }
    });
    
    combinedHtml += '</div>';
    
    // Add to right panel
    const resultsDiv = document.createElement('div');
    resultsDiv.innerHTML = combinedHtml;
    rightPanel.appendChild(resultsDiv);
}

function generateParetoResultsHtml(data) {
    return `
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
            <h3 style="color: #dc3545; margin-bottom: 1rem;">üîç Failure Pareto Analysis</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">${data.total_failed_logs}</div>
                    <div style="color: #666;">Failed Logs Analyzed</div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #fd7e14;">${data.unique_failed_tests}</div>
                    <div style="color: #666;">Unique Failed Tests</div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #6f42c1;">${data.unique_first_errors}</div>
                    <div style="color: #666;">Unique First Errors</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">üî• Top Failed Tests:</h4>
                    <ol style="margin: 0; padding-left: 1.5rem;">
                        ${data.top_failed_tests.map(([test, count]) => 
                            `<li style="margin: 0.25rem 0;"><strong>${test}</strong>: ${count} failures</li>`
                        ).join('')}
                    </ol>
                </div>
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">‚ö†Ô∏è Top First Errors:</h4>
                    <ol style="margin: 0; padding-left: 1.5rem;">
                        ${data.top_first_errors.map(([error, count]) => 
                            `<li style="margin: 0.25rem 0;"><strong>${error}</strong>: ${count} occurrences</li>`
                        ).join('')}
                    </ol>
                </div>
            </div>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #e7f3ff; border-radius: 6px;">
                <h4 style="color: #0066cc; margin-bottom: 0.5rem;">üìä Pareto Charts Generated:</h4>
                <p style="margin: 0; color: #666;">
                    Charts saved to: <code>${data.output_dir}</code><br>
                    ‚Ä¢ Failed Tests Pareto Chart<br>
                    ‚Ä¢ First Errors Pareto Chart
                </p>
            </div>
        </div>
    `;
}
</script>
{% endblock %}
