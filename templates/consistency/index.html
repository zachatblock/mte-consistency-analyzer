{% extends "base.html" %}

{% block title %}Consistency Plots - W3A Test Analysis{% endblock %}

{% block content %}
<div class="four-panel-layout">
    <div class="panel left-panel">
        <div class="panel-header">
            <h3>Test Plan CSV</h3>
        </div>
        <div class="panel-content">
            <div class="file-upload-section">
                <div class="form-group">
                    <label for="csv_file_path">File Path</label>
                    <input type="text" 
                           class="form-control" 
                           id="csv_file_path" 
                           placeholder="/path/to/test_plan.csv">
                </div>
                
                <div class="form-group">
                    <label for="csv_file_upload">Or Browse File</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="csv_file_upload" 
                           accept=".csv"
                           style="margin-bottom: 0.5rem;">
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-sm btn-primary" onclick="uploadFile('csv')">
                        Upload
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearFile('csv')">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="file-display" id="csv_display" style="display: none;">
                <h4>File Content:</h4>
                <div class="file-content" id="csv_content"></div>
            </div>
        </div>
    </div>

    <div class="panel second-panel">
        <div class="panel-header">
            <h3>Test Plan YAML</h3>
        </div>
        <div class="panel-content">
            <div class="file-upload-section">
                <div class="form-group">
                    <label for="yaml_file_path">File Path</label>
                    <input type="text" 
                           class="form-control" 
                           id="yaml_file_path" 
                           placeholder="/path/to/test_plan.yaml">
                </div>
                
                <div class="form-group">
                    <label for="yaml_file_upload">Or Browse File</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="yaml_file_upload" 
                           accept=".yaml,.yml"
                           style="margin-bottom: 0.5rem;">
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-sm btn-primary" onclick="uploadFile('yaml')">
                        Upload
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearFile('yaml')">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="file-display" id="yaml_display" style="display: none;">
                <h4>File Content:</h4>
                <div class="file-content" id="yaml_content"></div>
            </div>
        </div>
    </div>

    <div class="panel third-panel">
        <div class="panel-header">
            <h3>Step Config YAML</h3>
        </div>
        <div class="panel-content">
            <div class="file-upload-section">
                <div class="form-group">
                    <label for="step_file_path">File Path</label>
                    <input type="text" 
                           class="form-control" 
                           id="step_file_path" 
                           placeholder="/path/to/step_config.yaml">
                </div>
                
                <div class="form-group">
                    <label for="step_file_upload">Or Browse File</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="step_file_upload" 
                           accept=".yaml,.yml"
                           style="margin-bottom: 0.5rem;">
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-sm btn-primary" onclick="uploadFile('step')">
                        Upload
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearFile('step')">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="file-display" id="step_display" style="display: none;">
                <h4>File Content:</h4>
                <div class="file-content" id="step_content"></div>
            </div>
        </div>
    </div>

    <div class="panel right-panel">
        <div class="panel-header">
            <h3>Generate Consistency Plots</h3>
            <p>Upload your W3A test logs to generate statistical process control charts with ¬±3œÉ limits.</p>
        </div>
        <div class="panel-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div id="alert-container">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'error' if category == 'error' else category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="file-upload-section">
                <div class="form-group">
                    <label for="log_file_upload">Select Log Files or ZIP Archive</label>
                    <input type="file" 
                           class="form-control-file" 
                           id="log_file_upload" 
                           multiple 
                           accept=".zip,.csv">
                    <small class="form-text text-muted">
                        Select your ZIP archive or individual CSV/ZIP files containing W3A test logs.
                    </small>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="clearLogs()">
                        üóëÔ∏è Clear Selection
                    </button>
                </div>
            </div>

            <div class="report-selection-section">
                <h4>Report Types</h4>
                <div class="checkbox-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="consistency-report" onchange="updateGenerateButton()">
                        <label class="form-check-label" for="consistency-report">
                            Generate Consistency Plots (with USL/LSL limits)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="failure-pareto" onchange="updateGenerateButton()">
                        <label class="form-check-label" for="failure-pareto">
                            Generate Failure Pareto
                        </label>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary btn-lg w-100 mt-3" id="generate-plots-btn" onclick="generatePlots()">
                    <span id="btn-text">Please select at least one report type</span>
                    <span id="loading-spinner" style="display: none;">
                        Processing... ‚è≥
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.four-panel-layout {
    display: flex;
    height: calc(100vh - 140px);
    gap: 1rem;
    padding: 1rem;
}

.panel {
    flex: 1;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow-y: auto;
}

.panel-header {
    background-color: #f8f9fa;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
}

.panel-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.25rem;
}

.panel-header p {
    margin: 0.5rem 0 0 0;
    color: #666;
    font-size: 0.9rem;
}

.panel-content {
    padding: 1.5rem;
}

.left-panel, .second-panel, .third-panel {
    max-width: 250px;
}

.right-panel {
    flex: 2;
    min-width: 400px;
}
.example-paths {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    border-left: 4px solid #3498db;
}

.example-paths code {
    display: block;
    margin: 0.5rem 0;
    padding: 0.25rem 0.5rem;
    background-color: #e9ecef;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

.info-section h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
}

.info-section h4 {
    color: #3498db;
    margin-bottom: 0.5rem;
}

.form-text {
    color: #6c757d;
    font-size: 0.875rem;
}

.config-section {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 6px;
    margin: 1.5rem 0;
    border-left: 4px solid #17a2b8;
}

.config-section h4 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.config-section p {
    margin-bottom: 1rem;
}

/* File Upload Styling */
.file-upload-section {
    margin-bottom: 1.5rem;
}

.file-upload-section .form-group {
    margin-bottom: 1rem;
}

.file-upload-section label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    display: block;
}

.form-control-file {
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.button-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}

.file-display {
    margin-top: 1.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.file-display h4 {
    color: #2c3e50;
    margin-bottom: 0.75rem;
    font-size: 1rem;
}

.file-content {
    background-color: #fff;
    padding: 1rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Report Selection Styling */
.report-selection-section {
    margin-top: 2rem;
    padding: 1.5rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.report-selection-section h4 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.checkbox-group {
    margin-bottom: 1rem;
}

.form-check {
    margin-bottom: 0.75rem;
    padding-left: 1.5rem;
}

.form-check-input {
    margin-left: -1.5rem;
    margin-top: 0.25rem;
}

.form-check-label {
    color: #495057;
    font-weight: 500;
    cursor: pointer;
    user-select: none;
}

.form-check-input:checked + .form-check-label {
    color: #007bff;
}

#generate-plots-btn.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('consistency-form').addEventListener('submit', function(e) {
    const btn = document.getElementById('generate-btn');
    const btnText = document.getElementById('btn-text');
    const spinner = document.getElementById('loading-spinner');
    
    // Show loading state
    btn.disabled = true;
    btnText.style.display = 'none';
    spinner.style.display = 'inline';
    
    // Validate form
    const logDir = document.getElementById('log_directory').value.trim();
    if (!logDir) {
        e.preventDefault();
        alert('Please enter a log directory path.');
        
        // Reset button
        btn.disabled = false;
        btnText.style.display = 'inline';
        spinner.style.display = 'none';
        return;
    }
});

// Auto-remove alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(function() {
                alert.remove();
            }, 500);
        });
    }, 5000);
});

// File upload functions
function uploadFile(fileType) {
    let fileInput, pathInput;
    
    if (fileType === 'csv') {
        fileInput = document.getElementById('csv_file_upload');
        pathInput = document.getElementById('csv_file_path');
    } else if (fileType === 'yaml') {
        fileInput = document.getElementById('yaml_file_upload');
        pathInput = document.getElementById('yaml_file_path');
    } else if (fileType === 'step') {
        fileInput = document.getElementById('step_file_upload');
        pathInput = document.getElementById('step_file_path');
    }
    
    const file = fileInput.files[0];
    const filePath = pathInput.value.trim();
    
    if (!file && !filePath) {
        alert('Please select a file or enter a file path.');
        return;
    }
    
    if (file) {
        // Handle file upload via FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_type', fileType);
        
        fetch('/upload_file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFileContent(fileType, data.content, data.filename);
            } else {
                alert('Upload error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed: ' + error.message);
        });
        
    } else if (filePath) {
        // Handle file path via JSON
        fetch('/read_file_path', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_path: filePath,
                file_type: fileType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFileContent(fileType, data.content, data.filename);
            } else {
                alert('File read error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('File read failed: ' + error.message);
        });
    }
}

function clearFile(fileType) {
    // Clear inputs
    if (fileType === 'csv') {
        document.getElementById('csv_file_upload').value = '';
        document.getElementById('csv_file_path').value = '';
        document.getElementById('csv_display').style.display = 'none';
    } else if (fileType === 'yaml') {
        document.getElementById('yaml_file_upload').value = '';
        document.getElementById('yaml_file_path').value = '';
        document.getElementById('yaml_display').style.display = 'none';
    } else if (fileType === 'step') {
        document.getElementById('step_file_upload').value = '';
        document.getElementById('step_file_path').value = '';
        document.getElementById('step_display').style.display = 'none';
    }
}

function displayFileContent(fileType, content, fileName) {
    let displayDiv, contentDiv;
    
    if (fileType === 'csv') {
        displayDiv = document.getElementById('csv_display');
        contentDiv = document.getElementById('csv_content');
    } else if (fileType === 'yaml') {
        displayDiv = document.getElementById('yaml_display');
        contentDiv = document.getElementById('yaml_content');
    } else if (fileType === 'step') {
        displayDiv = document.getElementById('step_display');
        contentDiv = document.getElementById('step_content');
    }
    
    // Limit content display to first 2000 characters for performance
    let displayContent = content;
    if (content.length > 2000) {
        displayContent = content.substring(0, 2000) + '\n\n... (content truncated, showing first 2000 characters)';
    }
    
    contentDiv.textContent = `File: ${fileName}\n\n${displayContent}`;
    displayDiv.style.display = 'block';
}

// New log upload functions
function uploadLogs() {
    const fileInput = document.getElementById('log_file_upload');
    const pathInput = document.getElementById('log_directory_path');
    
    const files = fileInput.files;
    const dirPath = pathInput.value.trim();
    
    if (files.length === 0 && !dirPath) {
        alert('Please select log files or enter a directory path.');
        return;
    }
    
    if (files.length > 0) {
        // Handle file uploads
        alert(`Selected ${files.length} files for processing. Files will be processed when you click "Generate Consistency Plots".`);
    } else if (dirPath) {
        // Handle directory path
        alert(`Directory path set: ${dirPath}\nClick "Generate Consistency Plots" to process logs from this directory.`);
    }
}

function clearLogs() {
    document.getElementById('log_file_upload').value = '';
    // Clear any existing results
    const rightPanel = document.querySelector('.right-panel .panel-content');
    const existingResults = rightPanel.querySelector('.combined-results');
    if (existingResults) {
        existingResults.remove();
    }
}

// Update generate button based on checkbox selection
function updateGenerateButton() {
    const consistencyCheck = document.getElementById('consistency-report').checked;
    const paretoCheck = document.getElementById('failure-pareto').checked;
    
    const btn = document.getElementById('generate-plots-btn');
    const btnText = document.getElementById('btn-text');
    
    const selectedCount = [consistencyCheck, paretoCheck].filter(Boolean).length;
    
    if (selectedCount === 0) {
        btnText.textContent = 'Please select at least one report type';
        btn.classList.add('disabled');
        btn.disabled = true;
    } else {
        let reportTypes = [];
        if (consistencyCheck) reportTypes.push('Consistency Plots');
        if (paretoCheck) reportTypes.push('Pareto');
        
        btnText.textContent = `Generate ${reportTypes.join(' + ')} Report${selectedCount > 1 ? 's' : ''}`;
        btn.classList.remove('disabled');
        btn.disabled = false;
    }
}

function generatePlots() {
    // Check if button is disabled
    const btn = document.getElementById('generate-plots-btn');
    if (btn.disabled) {
        alert('Please select at least one report type first.');
        return;
    }
    
    const fileInput = document.getElementById('log_file_upload');
    const btnText = document.getElementById('btn-text');
    const spinner = document.getElementById('loading-spinner');
    
    const files = fileInput.files;
    
    console.log('DEBUG JS: generatePlots() called');
    console.log('DEBUG JS: fileInput:', fileInput);
    console.log('DEBUG JS: files.length:', files.length);
    
    if (files.length === 0) {
        alert('Please select log files or ZIP archive first.');
        return;
    }
    
    // Get the first file (for now we'll handle single file/ZIP)
    const selectedFile = files[0];
    console.log('DEBUG JS: selectedFile:', selectedFile.name);
    
    // Get selected report types
    const consistencyCheck = document.getElementById('consistency-report').checked;
    const paretoCheck = document.getElementById('failure-pareto').checked;
    
    // Show loading state
    btn.disabled = true;
    btnText.style.display = 'none';
    spinner.style.display = 'inline';
    
    // Process each selected report type
    const promises = [];
    
    if (consistencyCheck) {
        promises.push(generateConsistencyReport(selectedFile));
    }
    
    if (paretoCheck) {
        promises.push(generateParetoReport(selectedFile));
    }
    
    // Execute all selected reports
    Promise.all(promises)
        .then(results => {
            displayCombinedResults(results);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Report generation failed: ' + error.message);
        })
        .finally(() => {
            // Reset button
            btn.disabled = false;
            btnText.style.display = 'inline';
            spinner.style.display = 'none';
            updateGenerateButton(); // Restore proper button state
        });
}

// Individual report generation functions
function generateConsistencyReport(selectedFile) {
    console.log('DEBUG JS: generateConsistencyReport called with selectedFile:', selectedFile);
    
    // Upload the file first, then process it
    const formData = new FormData();
    formData.append('log_file', selectedFile);
    
    console.log('DEBUG JS: Uploading file for consistency plots...');
    
    return fetch('/upload_log_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(uploadData => {
        if (!uploadData.success) {
            throw new Error('File upload failed: ' + uploadData.error);
        }
        
        console.log('DEBUG JS: File uploaded successfully, generating consistency plots...');
        
        // Get config file paths from the UI inputs (if any)
        const testPlanPath = document.getElementById('yaml_file_path').value.trim();
        const stepConfigPath = document.getElementById('step_file_path').value.trim();
        
        // Now generate consistency plots
        return fetch('/generate_consistency_plots', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                log_path: uploadData.file_path,
                test_plan_path: testPlanPath,
                step_config_path: stepConfigPath
            })
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return {
                type: 'consistency',
                data: data,
                success: true
            };
        } else {
            throw new Error('Consistency plot generation error: ' + data.error);
        }
    });
}

function exportAllPlots(outputDir) {
    // Create a request to download all plots as a ZIP archive
    fetch('/export_plots', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            output_dir: outputDir
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Export failed');
        }
        return response.blob();
    })
    .then(blob => {
        // Create a download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `w3a_consistency_plots_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        alert('All plots exported successfully!');
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Failed to export plots: ' + error.message);
    });
}

function generateParetoReport(selectedFile) {
    console.log('DEBUG JS: generateParetoReport called with selectedFile:', selectedFile);
    console.log('DEBUG JS: selectedFile.name:', selectedFile.name);
    console.log('DEBUG JS: selectedFile.size:', selectedFile.size);
    
    // Upload the file first, then process it
    const formData = new FormData();
    formData.append('log_file', selectedFile);
    
    console.log('DEBUG JS: Uploading file to server...');
    
    return fetch('/upload_log_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(uploadData => {
        if (!uploadData.success) {
            throw new Error('File upload failed: ' + uploadData.error);
        }
        
        console.log('DEBUG JS: File uploaded successfully, server path:', uploadData.file_path);
        
        // Now analyze the uploaded file
        return fetch('/analyze_failures', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                log_path: uploadData.file_path
            })
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return {
                type: 'pareto',
                data: data,
                success: true
            };
        } else {
            throw new Error('Pareto analysis error: ' + data.error);
        }
    });
}

function displayCombinedResults(results) {
    // Clear any existing results
    const rightPanel = document.querySelector('.right-panel .panel-content');
    const existingResults = rightPanel.querySelector('.combined-results');
    
    if (existingResults) {
        existingResults.remove();
    }
    
    let combinedHtml = '<div class="combined-results" style="margin-top: 2rem;">';
    
    results.forEach(result => {
        if (result.type === 'consistency') {
            combinedHtml += generateConsistencyResultsHtml(result.data);
        } else if (result.type === 'pareto') {
            combinedHtml += generateParetoResultsHtml(result.data);
        }
    });
    
    combinedHtml += '</div>';
    
    // Add to right panel
    const resultsDiv = document.createElement('div');
    resultsDiv.innerHTML = combinedHtml;
    rightPanel.appendChild(resultsDiv);
}

function generateConsistencyResultsHtml(data) {
    // Generate plots section HTML
    let plotsHtml = '';
    if (data.plot_results && data.plot_results.length > 0) {
        plotsHtml = `
            <div style="margin-top: 2rem;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="color: #2c3e50; margin: 0;">üìä Generated Plots</h4>
                    <button type="button" class="btn btn-success btn-sm" onclick="exportAllPlots('${data.output_dir}')">
                        üìÅ Export All Plots
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1rem;">
                    ${data.plot_results.map(plot => `
                        <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #dee2e6;">
                            <h5 style="color: #2c3e50; margin-bottom: 0.5rem; font-size: 1rem;">${plot.test_id}</h5>
                            <div style="text-align: center; margin-bottom: 0.5rem;">
                                <img src="data:image/png;base64,${plot.plot_base64}" 
                                     alt="${plot.test_id} Consistency Plot" 
                                     style="max-width: 100%; height: auto; border-radius: 4px;">
                            </div>
                            <div style="font-size: 0.8rem; color: #666; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <div><strong>Samples:</strong> ${plot.n_samples}</div>
                                <div><strong>Mean:</strong> ${plot.mean.toFixed(3)}</div>
                                <div><strong>Std:</strong> ${plot.std.toFixed(3)}</div>
                                <div><strong>Out of Control:</strong> ${plot.out_of_control_total}</div>
                                ${plot.has_limits ? `
                                    <div><strong>USL Violations:</strong> ${plot.usl_violations}</div>
                                    <div><strong>LSL Violations:</strong> ${plot.lsl_violations}</div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    return `
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff;">
            <h3 style="color: #007bff; margin-bottom: 1rem;">üìä Consistency Plots Generated</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #007bff;">${data.total_tests || 0}</div>
                    <div style="color: #666;">Unique Tests</div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${data.plots_generated || 0}</div>
                    <div style="color: #666;">Plots Generated</div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #6f42c1;">${data.csv_files_processed || 0}</div>
                    <div style="color: #666;">CSV Files Processed</div>
                </div>
                ${(data.test_limits_loaded || 0) > 0 ? `
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #fd7e14;">${data.test_limits_loaded}</div>
                    <div style="color: #666;">USL/LSL Limits Applied</div>
                </div>
                ` : ''}
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">üìà Features Generated:</h4>
                <ul style="margin: 0; padding-left: 1.5rem; background: white; padding: 1rem; border-radius: 6px;">
                    <li style="margin: 0.25rem 0;">‚úÖ Statistical Process Control (SPC) charts with ¬±3œÉ limits</li>
                    <li style="margin: 0.25rem 0;">‚úÖ Serial number color coding (549 = Red, 602 = Blue)</li>
                    <li style="margin: 0.25rem 0;">‚úÖ Pass/Fail status indicators</li>
                    <li style="margin: 0.25rem 0;">‚úÖ Out-of-control point detection</li>
                    <li style="margin: 0.25rem 0;">‚úÖ USL/LSL specification limits extracted from CSV files</li>
                    <li style="margin: 0.25rem 0;">‚úÖ Comprehensive statistics box with sample counts</li>
                </ul>
            </div>
            
            ${plotsHtml}
        </div>
    `;
}

function generateParetoResultsHtml(data) {
    return `
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
            <h3 style="color: #dc3545; margin-bottom: 1rem;">üîç Failure Pareto Analysis (Root Cause)</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">${data.total_failed_logs}</div>
                    <div style="color: #666;">Failed Units Analyzed</div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #6f42c1;">${data.unique_first_errors}</div>
                    <div style="color: #666;">Unique Root Causes</div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${data.total_failed_files}</div>
                    <div style="color: #666;">Log Files Processed</div>
                </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">üî• Top Root Causes (First Error Types):</h4>
                <ol style="margin: 0; padding-left: 1.5rem; background: white; padding: 1rem; border-radius: 6px;">
                    ${data.top_first_errors && data.top_first_errors.length > 0 ? 
                        data.top_first_errors.map(([error, count]) => 
                            `<li style="margin: 0.5rem 0;"><strong>${error}</strong>: ${count} occurrences</li>`
                        ).join('') :
                        '<li style="color: #666;">No first error data available</li>'
                    }
                </ol>
            </div>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #e7f3ff; border-radius: 6px;">
                <h4 style="color: #0066cc; margin-bottom: 0.5rem;">üìä Pareto Chart Generated:</h4>
                <p style="margin: 0; color: #666;">
                    Chart saved to: <code>${data.output_dir}</code><br>
                    ‚Ä¢ First Error Types (Root Cause Analysis) Chart
                </p>
            </div>
        </div>
    `;
}
</script>
{% endblock %}
